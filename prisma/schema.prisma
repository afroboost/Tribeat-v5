// ========================================
// Tribeat Database Schema
// Compatible Vercel + PostgreSQL
// Prisma ORM
// ========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// USERS & AUTHENTICATION
// ========================================

enum UserRole {
  SUPER_ADMIN
  COACH
  PARTICIPANT
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      UserRole @default(PARTICIPANT)
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  coachedSessions  Session[]           @relation("CoachSessions")
  sessionRoles     SessionParticipant[]
  messages         ChatMessage[]
  transactions     Transaction[]
  accesses         UserAccess[]

  @@index([email])
}

// ========================================
// SESSIONS LIVE
// ========================================

enum SessionStatus {
  SCHEDULED
  LIVE
  COMPLETED
  CANCELLED
}

enum MediaType {
  VIDEO
  AUDIO
  IMAGE
}

model Session {
  id          String        @id @default(cuid())
  title       String
  description String?
  coachId     String
  coach       User          @relation("CoachSessions", fields: [coachId], references: [id], onDelete: Cascade)

  mediaUrl    String?
  mediaType   MediaType?

  scheduledAt DateTime
  startedAt   DateTime?
  endedAt     DateTime?
  status      SessionStatus @default(SCHEDULED)

  maxParticipants Int?
  isPublic        Boolean @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  participants SessionParticipant[]
  messages     ChatMessage[]
  offers       Offer[]
  accesses     UserAccess[]
  liveState    LiveSessionState?

  @@index([coachId])
  @@index([status])
  @@index([scheduledAt])
}

// ========================================
// MANY-TO-MANY : USER â†” SESSION
// ========================================

enum ParticipantRole {
  COACH
  PARTICIPANT
  MODERATOR
}

model SessionParticipant {
  id        String          @id @default(cuid())
  userId    String
  sessionId String
  role      ParticipantRole @default(PARTICIPANT)
  joinedAt  DateTime        @default(now())
  leftAt    DateTime?

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([userId, sessionId])
  @@index([sessionId])
  @@index([userId])
}

// ========================================
// CHAT
// ========================================

model ChatMessage {
  id        String   @id @default(cuid())
  sessionId String
  userId    String
  content   String
  timestamp DateTime @default(now())

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([timestamp])
}

// ========================================
// UI SETTINGS
// ========================================

enum SettingCategory {
  THEME
  PWA
  GENERAL
}

model UI_Settings {
  id        String          @id @default(cuid())
  key       String          @unique
  value     String
  category  SettingCategory
  updatedAt DateTime        @updatedAt

  @@index([category])
}

// ========================================
// TRANSLATIONS
// ========================================

enum Language {
  FR
  EN
  DE
}

model Translation {
  id        String   @id @default(cuid())
  key       String
  language  Language
  value     String
  updatedAt DateTime @updatedAt

  @@unique([key, language])
  @@index([language])
}

// ========================================
// OFFERS
// ========================================

model Offer {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Int
  currency    String   @default("CHF")
  sessionId   String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  session      Session?      @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  transactions Transaction[]

  @@index([sessionId])
  @@index([isActive])
}

// ========================================
// TRANSACTIONS
// ========================================

enum TransactionProvider {
  MANUAL
  STRIPE
  PAYSTACK
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Transaction {
  id           String              @id @default(cuid())
  userId       String
  offerId      String?
  amount       Int
  currency     String              @default("CHF")
  provider     TransactionProvider
  providerTxId String?
  status       TransactionStatus   @default(PENDING)
  metadata     Json?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  offer      Offer?      @relation(fields: [offerId], references: [id], onDelete: SetNull)
  userAccess UserAccess?

  @@index([userId])
  @@index([offerId])
  @@index([status])
  @@index([providerTxId])
}

// ========================================
// USER ACCESS
// ========================================

enum AccessStatus {
  PENDING
  ACTIVE
  EXPIRED
  REVOKED
}

model UserAccess {
  id            String       @id @default(cuid())
  userId        String
  sessionId     String?
  offerId       String?
  transactionId String?      @unique
  status        AccessStatus @default(PENDING)
  grantedAt     DateTime     @default(now())
  expiresAt     DateTime?
  revokedAt     DateTime?
  revokedBy     String?

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  session     Session?     @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  transaction Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([sessionId])
  @@index([status])
}

// ========================================
// LIVE SESSION STATE
// ========================================

model LiveSessionState {
  id          String   @id @default(cuid())
  sessionId   String   @unique

  isPlaying   Boolean  @default(false)
  currentTime Float    @default(0)
  volume      Int      @default(80)

  lastEventBy String?
  lastEventAt DateTime @default(now())

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}
